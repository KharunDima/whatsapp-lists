name: Update WhatsApp Lists

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
    - cron: '0 */6 * * *'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  push:
    branches: [ main ]

# –†–∞–∑—Ä–µ—à–∞–µ–º workflow –ø–∏—Å–∞—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
permissions:
  contents: write  # –í–∞–∂–Ω–æ: –¥–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å!

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        # –£–±–∏—Ä–∞–µ–º persist-credentials: false, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—É—à–∏—Ç—å
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsutils curl whois
        
    - name: Run WhatsApp Discovery
      run: |
        cd scripts
        chmod +x aggressive-discovery.sh
        ./aggressive-discovery.sh
        
    - name: Check for changes
      id: git-check
      run: |
        git config --local user.email "github-actions@github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–ø–∏—Å–∫–∞—Ö"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "üì¨ –ù–∞–π–¥–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–∞—Ö!"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add -A
          git commit -m "ü§ñ Auto-update WhatsApp lists - $(date '+%Y-%m-%d %H:%M:%S')
          
          üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
          - –î–æ–º–µ–Ω—ã: $(grep -c '^[^#]' lists/domains.txt 2>/dev/null || echo 0)
          - CIDR: $(grep -c '^[^#]' lists/cidr.txt 2>/dev/null || echo 0)
          
          –°—Å—ã–ª–∫–∏:
          - https://raw.githubusercontent.com/${{ github.repository }}/main/lists/domains.txt
          - https://raw.githubusercontent.com/${{ github.repository }}/main/lists/cidr.txt"
        fi
        
    - name: Push changes
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git pull --rebase
        git push
        
    - name: Show results
      run: |
        echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
        echo "========================="
        echo ""
        
        if [ -f lists/domains.txt ]; then
          DOMAIN_COUNT=$(grep -c '^[^#]' lists/domains.txt 2>/dev/null || echo 0)
          echo "‚úÖ –î–æ–º–µ–Ω—ã: $DOMAIN_COUNT"
        fi
        
        if [ -f lists/cidr.txt ]; then
          CIDR_COUNT=$(grep -c '^[^#]' lists/cidr.txt 2>/dev/null || echo 0)
          echo "‚úÖ CIDR: $CIDR_COUNT"
        fi
        
        if [ -f lists/NEW_DOMAINS.txt ]; then
          NEW_COUNT=$(grep -c '^[^#]' lists/NEW_DOMAINS.txt 2>/dev/null || echo 0)
          if [ "$NEW_COUNT" -gt 0 ]; then
            echo ""
            echo "üéâ –ù–æ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤: $NEW_COUNT"
            echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –Ω–æ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤:"
            grep -v '^#' lists/NEW_DOMAINS.txt | tail -5
          fi
        fi
        
        echo ""
        echo "üîó –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–ø–∏—Å–∫–∏:"
        echo "- –î–æ–º–µ–Ω—ã: https://raw.githubusercontent.com/${{ github.repository }}/main/lists/domains.txt"
        echo "- CIDR: https://raw.githubusercontent.com/${{ github.repository }}/main/lists/cidr.txt"
