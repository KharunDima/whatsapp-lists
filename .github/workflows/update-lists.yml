name: Update WhatsApp Lists

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
    - cron: '0 * * * *'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  push:
    branches: [ main ]

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        persist-credentials: false
        
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsutils curl whois
        
    - name: Run WhatsApp Discovery
      run: |
        cd scripts
        chmod +x aggressive-discovery.sh
        ./aggressive-discovery.sh
        
    - name: Check for changes
      id: git-check
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ../lists/
        
        if git diff --cached --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–ø–∏—Å–∫–∞—Ö"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "üì¨ –ù–∞–π–¥–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–∞—Ö!"
          git commit -m "Auto-update WhatsApp lists - $(date '+%Y-%m-%d %H:%M:%S')"
        fi
        
    - name: Push changes
      if: steps.git-check.outputs.changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
        
    - name: Show results
      run: |
        echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
        echo "–î–æ–º–µ–Ω—ã: $(wc -l < lists/domains.txt)"
        echo "CIDR: $(wc -l < lists/cidr.txt)"
        
        if [ -f lists/NEW_DOMAINS.txt ]; then
          echo "–ù–æ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤: $(grep -c '^[^#]' lists/NEW_DOMAINS.txt 2>/dev/null || echo 0)"
          echo ""
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤—ã–µ –¥–æ–º–µ–Ω—ã:"
          tail -5 lists/NEW_DOMAINS.txt | grep -v '^#' | head -5
        fi
